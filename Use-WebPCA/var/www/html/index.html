<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析</title>
</head>
<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpj3dmrsum4pEmVyvml1JCj08ZZ89SJ70",
            authDomain: "hac-it-ai-gcp-sweptsine.firebaseapp.com",
            databaseURL: "https://hac-it-ai-gcp-sweptsine-default-rtdb.firebaseio.com",
            projectId: "hac-it-ai-gcp-sweptsine",
            storageBucket: "hac-it-ai-gcp-sweptsine.appspot.com",
            messagingSenderId: "229363724832",
            appId: "1:229363724832:web:5ee07eb67251875a350245"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let collections = [];
        let selectedCollections = [];

        async function getCollections() {
            const snapshot = await getDocs(collection(db, "test"));
            snapshot.forEach((doc) => {
                collections.push(doc.id);
            });
            populateSelect(collections);
        }

        function populateSelect(collections) {
            const selectElement = document.getElementById("collection_select");
            collections.forEach((collection) => {
                const option = document.createElement("option");
                option.value = collection;
                option.textContent = collection;
                selectElement.appendChild(option);
            });
        }

        window.addCollection = function() {
            const selectElement = document.getElementById("collection_select");
            const selectedValue = selectElement.value;
            if (selectedValue && !selectedCollections.includes(selectedValue)) {
                selectedCollections.push(selectedValue);
                updateSelectedList();
                updateHiddenField(); // 隠しフィールドを更新
            }
        };

        function updateSelectedList() {
            const selectedListElement = document.getElementById("selected_collections");
            selectedListElement.innerHTML = "";
            selectedCollections.forEach((collection) => {
                const listItem = document.createElement("li");
                listItem.textContent = collection;
                selectedListElement.appendChild(listItem);
            });
        }

        // 隠しフィールドを更新する関数
        function updateHiddenField() {
            const hiddenField = document.getElementById("selected_collections_input");
            hiddenField.value = selectedCollections.join(", "); // 選択したコレクションをカンマ区切りの文字列に
        }

        getCollections().catch(error => {
            console.error("Error getting collections: ", error);
        });
    </script>

    <h1>Analyze using measurement data</h1>

    <label for="collection_select">Select data for comparison:</label>
    <select id="collection_select" required onchange="addCollection()">
        <option value="">Collection</option>
    </select>

    <h2>Your Collections</h2>
    <ul id="selected_collections"></ul>

    <form action="/cgi-bin/image_generator.py" method="post">
        <label for="input_text">Mapping data name:</label>
        <input type="text" id="input_text" name="input_text" required>
        
        <!-- 隠しフィールドを追加 -->
        <input type="hidden" id="selected_collections_input" name="selected_collections" value="">
        
        <input type="submit" value="Start!">
    </form>

    If there is no data to select, please wait for a while.
</body>
</html>
